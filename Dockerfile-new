
# State-of-the-art C++ Build Container
# Based on Ubuntu 24.04 LTS (Noble Numbat)
FROM ubuntu:24.04

# Metadata
LABEL maintainer="Stig Sandnes <stig_sandnes@hotmail.com>" \
      description="Modern C++ build container with latest CMake, GCC, and Clang" \
      base.image="ubuntu:24.04" \
      cmake.source="apt.kitware.com" \
      llvm.source="apt.llvm.org" \
      gcc.source="ubuntu-toolchain-r/test"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=UTC

# Install basic dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    gpg \
    wget \
    curl \
    software-properties-common \
    apt-transport-https \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# Add Kitware APT repository for latest CMake
RUN wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null \
    | gpg --dearmor - \
    | tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null \
    && echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ noble main' \
    | tee /etc/apt/sources.list.d/kitware.list >/dev/null \
    && apt-get update \
    && apt-get install -y --no-install-recommends kitware-archive-keyring \
    && rm -rf /var/lib/apt/lists/*

# Add LLVM APT repository for latest Clang (version 22 - development branch)
RUN wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key \
    | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc \
    && echo 'deb http://apt.llvm.org/noble/ llvm-toolchain-noble main' \
    | tee /etc/apt/sources.list.d/llvm.list >/dev/null \
    && echo 'deb http://apt.llvm.org/noble/ llvm-toolchain-noble-22 main' \
    | tee -a /etc/apt/sources.list.d/llvm.list >/dev/null

# Add Ubuntu Toolchain PPA for latest GCC
RUN add-apt-repository -y ppa:ubuntu-toolchain-r/test

# Update package lists and install build tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Latest CMake from Kitware
    cmake \
    cmake-curses-gui \
    # Latest GCC (GCC 14)
    gcc-14 \
    g++-14 \
    gfortran-14 \
    # Latest Clang/LLVM (version 22)
    clang-22 \
    clang-tools-22 \
    clang-format-22 \
    clang-tidy-22 \
    clangd-22 \
    libc++-22-dev \
    libc++abi-22-dev \
    libclang-22-dev \
    libclang1-22 \
    libclang-rt-22-dev \
    lld-22 \
    lldb-22 \
    llvm-22 \
    llvm-22-dev \
    llvm-22-runtime \
    libomp-22-dev \
    libpolly-22-dev \
    libfuzzer-22-dev \
    # Additional development tools
    ninja-build \
    make \
    autoconf \
    automake \
    libtool \
    pkg-config \
    git \
    ccache \
    # Common libraries
    libssl-dev \
    zlib1g-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    libncurses5-dev \
    libgdbm-dev \
    libnss3-dev \
    libffi-dev \
    liblzma-dev \
    # Debugging and analysis tools
    gdb \
    valgrind \
    strace \
    && rm -rf /var/lib/apt/lists/*

# Set GCC 14 as default
RUN update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100 \
    && update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100 \
    && update-alternatives --install /usr/bin/gfortran gfortran /usr/bin/gfortran-14 100 \
    && update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-14 100

# Set Clang 22 as alternative compiler (not default to avoid conflicts)
RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-22 100 \
    && update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-22 100 \
    && update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-22 100 \
    && update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-22 100 \
    && update-alternatives --install /usr/bin/clangd clangd /usr/bin/clangd-22 100 \
    && update-alternatives --install /usr/bin/lld lld /usr/bin/lld-22 100 \
    && update-alternatives --install /usr/bin/lldb lldb /usr/bin/lldb-22 100

# Create a non-root user for building
RUN groupadd -r builder && useradd --no-log-init -r -g builder -m -s /bin/bash builder

# Set up ccache for faster rebuilds
ENV CCACHE_DIR=/home/builder/.ccache \
    CCACHE_MAXSIZE=5G \
    PATH="/usr/lib/ccache:${PATH}"

# Display versions for verification
RUN echo "=== Build Environment Versions ===" \
    && cmake --version \
    && echo "" \
    && gcc --version \
    && echo "" \
    && g++ --version \
    && echo "" \
    && clang --version \
    && echo "" \
    && clang++ --version \
    && echo "" \
    && ninja --version

# Set working directory
WORKDIR /project

# Switch to non-root user
USER builder

# Default command
CMD ["/bin/bash"]
